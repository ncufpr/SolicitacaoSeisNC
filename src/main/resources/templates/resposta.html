<!DOCTYPE html>
<html lang="pt-br" xmlns="http://www.w3.org/1999/html" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<span th:replace="~{fragments/head}"/>
<span th:replace="~{fragments/navbar}"/>



<body>

<div class="main-content mt-0">
    <div class="card shadow-sm border-0 rounded-4" >
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-success text-center rounded-top-4">
                <h4 class="mb-0">‚úÖ Resposta da Solicita√ß√£o</h4>
            </div>

            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <strong>üìå Nome:</strong>
                        <div th:text="${respostaDTO.nomeSolicitante}"></div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>üìß Email:</strong>
                        <div th:text="${respostaDTO.emailSolicitante}"></div>
                    </div>

                    <div class="col-md-6 mb-2">
                        <strong>üî¢ N¬∫ da Solicita√ß√£o:</strong>
                        <div th:text="${respostaDTO.idSolicitacao}"></div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>üìÖ Data da Solicita√ß√£o:</strong>
                        <div th:text="${respostaDTO.dataSolicitacao}"></div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>üìå Concurso ou Processo Seletivo:</strong>
                        <div th:text="${respostaDTO.concurso}"></div>
                    </div>

                    <div class="col-md-6 mb-2">
                        <strong>üìå Tipo do Assunto:</strong>
                        <div th:text="${respostaDTO.tipoAssuntoResposta}"></div>
                    </div>
                </div>


                <hr class="my-4"/>
                <div class="mb-3">
                    <strong>üìù Solicita√ß√£o:</strong>
                    <p th:utext="${respostaDTO.solicitacao}"></p>
                </div>
                <hr class="my-4"/>

                <div class="mb-3">
                    <strong>üì© Resposta da Solicita√ß√£o:</strong>
                    <p th:utext="${respostaDTO.resposta}"></p>
                </div>

                <div class="mb-3" th:if="${respostaDTO.anexo}">
                    <strong>üìé Anexo:</strong>
                    <br/>
                        <span th:utext="${respostaDTO.anexo}"></span>
                </div>
                <!-- Bot√£o para mostrar o formul√°rio -->
                <hr class="my-4"/>
                <div th:if="${msgSuccess}" class="alert alert-success" id="msgSucess">
                    <span th:text="${msgSuccess}"></span>
                </div>
                <div th:if="${msgError}" class="alert alert-danger" id="msgError">
                    <span th:text="${msgError}"></span>
                </div>

<!--                <div th:if="${respostaDTO.avaliacao == null}">-->
                <div class="mb-3 text-center">
                    <div class="d-flex justify-content-center mt-3 gap-2 flex-wrap">
                        <a th:href="@{/form}" class="btn btn-primary">
                            ‚ûï Realizar uma nova solicita√ß√£o
                        </a>
                        <div th:if="${respostaDTO.avaliacao == null}">
                            <button id="btnAvaliar" class="btn btn-primary me-2">
                                ‚≠ê Avaliar Atendimento
                            </button>
                        </div>

                        <button id="btnNovaSolicitacao" class="btn btn-primary">
                            üí¨ Continuar este atendimento
                        </button>

                    </div>
                </div>
<!--                </div>-->
<!--                <div th:unless="${respostaDTO.avaliacao == null}">-->

<!--                </div>-->



                <!-- Container do formul√°rio oculto inicialmente -->
                <div id="containerFormulario" style="display: none;">
                    <div class="card-body">
                        <div class="card-header">Nova solicita√ß√£o</div>
                        <form th:action="@{/resposta/respostaSolicitacao}" th:object="${solicitacao}" method="post">
<!--                            <form th:action="@{/form}" th:object="${solicitacao}" method="post">-->
                            <input type="hidden" th:field="*{idSolicitacao}">
                            <div class="row">
                                <div class="col-lg-6 col-12 mb-3">
                                    <label for="inputConcurso" class="form-label">Selecione o Concurso ou o Processo Seletivo</label>
                                    <select class="form-select" th:field="*{concursoId}" id="inputConcurso" required>
                                        <option value="" selected>Selecione o Concurso ou o Processo Seletivo</option>
                                        <option th:each="concurso : ${concursos}"
                                                th:value="${concurso.concurso}"
                                                th:text="${concurso.descricao}">
                                        </option>
                                    </select>
                                    <div class="text-danger" th:errors="*{concurso}"></div>
                                </div>

                                <div class="col-lg-6 col-12 mb-3">
                                    <label class="form-label d-block">Selecione o tipo do assunto</label>
                                    <div th:each="assunto : ${assuntos}" class="form-check form-check-inline">
                                        <input class="form-check-input"
                                               type="radio"
                                               th:field="*{tipoAssunto}"
                                               th:value="${assunto.id}"
                                               th:id="${'assunto-' + assunto.id}">
                                        <label class="form-check-label" th:for="${'assunto-' + assunto.id}" th:text="${assunto.descricao}"></label>
                                    </div>
                                    <div class="text-danger" th:errors="*{tipoAssunto}"></div>
                                </div>
                            </div>

                            <!-- Nome e CPF -->
                            <div class="row">
                                <div class="col-md-6 col-12 mb-3">
                                    <label class="form-label">Nome do Solicitante</label>
                                    <input type="text" class="form-control" th:field="*{nome}" required>
                                    <div class="text-danger" th:errors="*{nome}"></div>
                                </div>
                                <div class="col-md-6 col-12 mb-3">
                                    <label class="form-label">N√∫mero do C.P.F.</label>
                                    <input type="text" class="form-control" readonly style="background-color: lightgrey" th:field="*{cpf}" required>
                                    <div class="text-danger" th:errors="*{cpf}"></div>
                                </div>
                            </div>

                            <!-- RG, UF e Data de Nascimento -->
                            <div class="row">
                                <div class="col-md-4 col-12 mb-3">
                                    <label class="form-label">N√∫mero do R.G.</label>
                                    <input type="text" class="form-control" th:field="*{rg}" required>
                                    <div class="text-danger" th:errors="*{rg}"></div>
                                </div>
                                <div class="col-md-4 col-12 mb-3">
                                    <label class="form-label">UF do R.G.</label>
                                    <select class="form-select" th:field="*{ufRg}" required>
                                        <option value="" disabled>Selecione a U.F.</option>
                                        <option th:each="uf : ${estados}"
                                                th:value="${uf.uf}"
                                                th:text="${uf.nome}">
                                        </option>
                                    </select>
                                    <div class="text-danger" th:errors="*{ufRg}"></div>
                                </div>
                                <div class="col-md-4 col-12 mb-3">
                                    <label class="form-label">Data de Nascimento</label>
                                    <input type="text" class="form-control" th:field="*{dataNascimento}" placeholder="DD/MM/AAAA" required>
                                    <div class="text-danger" th:errors="*{dataNascimento}"></div>
                                </div>
                            </div>

                            <!-- Email e Telefone -->
                            <div class="row">
                                <div class="col-12 col-md-6 mb-3">
                                    <label class="form-label">E-mail</label>
                                    <input type="email" class="form-control" th:field="*{email}" required>
                                    <div class="text-danger" th:errors="*{email}"></div>
                                </div>
                                <div class="col-12 col-md-2 mb-3">
                                    <label class="form-label">DDD</label>
                                    <input type="text" class="form-control" th:field="*{ddd}" required maxlength="2">
                                    <div class="text-danger" th:errors="*{ddd}"></div>
                                </div>
                                <div class="col-12 col-md-4 mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" th:field="*{telefone}" required>
                                    <div class="text-danger" th:errors="*{telefone}"></div>
                                </div>
                            </div>

                            <!-- Texto da Solicita√ß√£o -->
                            <div class="row" style="justify-content: center;">
                                <div class="col-12 col-md-9 mb-3">
                                    <label for="editor" class="form-label">Texto da Solicita√ß√£o</label>
                                    <textarea id="editor" class="form-control" th:field="*{solicitacao}" rows="10" required></textarea>
                                    <div class="text-danger" th:errors="*{solicitacao}"></div>
                                    <span class="text-danger" th:text="${erro}">Essa solicita√ß√£o j√° foi enviada! Por favor aguarde a resposta.</span>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn btn-primary">Enviar Mensagem</button>
                            </div>
                        </form>
                    </div>
                </div>


                <div th:if="${respostaDTO.avaliacao == null}">
                    <div id="avaliacaoContainer" style="display: none;" class="text-center mt-4">
                        <form th:action="@{/resposta/avaliar}" th:object="${respostaDTO}" method="post" id="formAvaliacao">
                            <input type="hidden" th:field="*{idRespostaSolicitacao}" />
                            <input type="hidden" th:field="*{codigoResposta}" />

                            <div class="star-rating">
                                <input id="star5" type="radio" th:field="*{avaliacao}" value="5">
                                <label for="star5" title="Excelente">‚òÖ</label>

                                <input id="star4" type="radio" th:field="*{avaliacao}" value="4">
                                <label for="star4" title="Bom">‚òÖ</label>

                                <input id="star3" type="radio" th:field="*{avaliacao}" value="3">
                                <label for="star3" title="Regular">‚òÖ</label>

                                <input id="star2" type="radio" th:field="*{avaliacao}" value="2">
                                <label for="star2" title="Ruim">‚òÖ</label>

                                <input id="star1" type="radio" th:field="*{avaliacao}" value="1">
                                <label for="star1" title="P√©ssimo">‚òÖ</label>
                            </div>
                            <div class="text-danger" th:errors="*{avaliacao}"></div>

                            <div id="comentarioContainer" class="mb-3 mt-3">
                <textarea th:field="*{comentario}" maxlength="1000" class="form-control"
                          rows="3" placeholder="Deixe seu coment√°rio"></textarea>
                                <div class="text-danger" th:errors="*{comentario}"></div>
                            </div>

                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary btn-sm">Enviar Avalia√ß√£o</button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>

        </div>

    </div>

</div>

<div th:replace="~{fragments/script}"/>
<script th:inline="javascript">
    $(document).ready(function() {
        // Recupera o valor do backend (true/false)
        const abrirFormulario = /*[[${abrirFormulario} ?: false]]*/ false;

        // Se true, mostra o formul√°rio e ajusta bot√£o
        if (abrirFormulario) {
            $('#containerFormulario').show();
            $('#btnNovaSolicitacao').html('‚ùå Cancelar esse atendimento');
        }

        // M√°scara para CPF
        $('input[name="cpf"]').mask('000.000.000-00');

        // M√°scara para DDD
        $('input[name="ddd"]').mask('00');

        // M√°scara para data de nascimento
        $('input[name="dataNascimento"]').mask('00/00/0000');

        // M√°scara din√¢mica para telefone
        var telefoneMaskBehavior = function (val) {
            return val.replace(/\D/g, '').length === 9 ? '00000-0000' : '0000-00009';
        };

        var telefoneOptions = {
            onKeyPress: function (val, e, field, options) {
                field.mask(telefoneMaskBehavior.apply({}, arguments), options);
            }
        };

        $('input[name="telefone"]').mask(telefoneMaskBehavior, telefoneOptions);

        // Fun√ß√£o para abrir/fechar se√ß√µes
        function toggleSection(button, sectionToShow, otherButton, otherSection, texts, otherTexts) {
            const isVisible = $(sectionToShow).is(':visible');

            if (isVisible) {
                $(sectionToShow).slideUp();
                button.html(texts.show);
            } else {
                $(sectionToShow).slideDown();
                $(otherSection).slideUp();
                button.html(texts.hide);
                otherButton.html(otherTexts.show);
            }
        }

        // Bot√£o Avaliar
        $('#btnAvaliar').click(function () {
            toggleSection(
                $(this), '#avaliacaoContainer',
                $('#btnNovaSolicitacao'), '#containerFormulario',
                { show: '‚≠ê Avaliar Atendimento', hide: '‚ùå Cancelar Avalia√ß√£o' },
                { show: 'üí¨ Continuar esse atendimento', hide: '‚ùå Cancelar esse atendimento' }
            );
        });

        // Bot√£o Nova Solicita√ß√£o
        $('#btnNovaSolicitacao').click(function () {
            toggleSection(
                $(this), '#containerFormulario',
                $('#btnAvaliar'), '#avaliacaoContainer',
                { show: 'üí¨ Continuar esse atendimento', hide: '‚ùå Cancelar esse atendimento' },
                { show: '‚≠ê Avaliar Atendimento', hide: '‚ùå Cancelar Avalia√ß√£o' }
            );
        });

        // Valida√ß√£o do formul√°rio de avalia√ß√£o
        const formAvaliacao = document.getElementById("formAvaliacao");
        if (formAvaliacao) {
            formAvaliacao.addEventListener("submit", function (e) {
                const notaSelecionada = $("input[name='avaliacao']:checked").val(); // Corrigido aqui

                if (!notaSelecionada) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Selecione uma nota',
                        text: 'Por favor, escolha uma estrela antes de enviar sua avalia√ß√£o. ‚≠ê',
                    });
                    return;
                }

                const comentario = $("#comentario").val().trim();
                if (parseInt(notaSelecionada, 10) < 5 && comentario.length === 0) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'info',
                        title: 'Coment√°rio obrigat√≥rio',
                        text: 'Por favor, descreva o motivo da avalia√ß√£o antes de enviar.',
                    });
                }
            });
        }
    });
</script>



</body>

</html>
